#!/usr/bin/env bash

function main {
  local shome="${_facts_home:-"$(cd -P -- "${BASH_SOURCE%/*}/.." && pwd -P)"}"
  source "$shome/script/profile"
  
  if [[ -f "$shome/.facts.json" && -z "${NO_FACTS_CACHE:-}" ]]; then
    cat "$shome/.facts.json"
  else
    ansible localhost -c local -m setup -o | sed 's#^[^{]*##' | jq '.ansible_facts as $f | reduce ($f | keys[] | select(startswith("ansible_"))) as $k ({}; .[$k | ltrimstr("ansible_")] = $f[$k])'
  fi | jq "$@"
}

source sub "$BASH_SOURCE" "$@"
